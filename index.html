<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiz Builder</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://unpkg.com/mammoth@1.6.0/mammoth.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    @keyframes progress { 0% { width: 0%; } 50% { width: 70%; } 100% { width: 95%; } }
    .progress-bar { height: 4px; background: linear-gradient(90deg, #f37021, #ff9a5c); border-radius: 2px; animation: progress 8s ease-out forwards; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useRef } = React;

    if (window.pdfjsLib) {
      window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }

    function QuizBuilder() {
      const [questions, setQuestions] = useState([]);
      const [errors, setErrors] = useState([]);
      const [showErrors, setShowErrors] = useState(false);
      const [showAIPanel, setShowAIPanel] = useState(false);
      const [aiMode, setAiMode] = useState('topic');
      const [isGenerating, setIsGenerating] = useState(false);
      const [genStatus, setGenStatus] = useState('');
      const fileInputRef = useRef(null);
      const abortControllerRef = useRef(null);
      const [isDragging, setIsDragging] = useState(false);
      
      const [aiSettings, setAiSettings] = useState({
        topic: '', pastedQuestions: '', numQuestions: 5, points: 10, qType: 'Single Choice',
        numAlts: 4, tags: '', difficulty: 'N/A', addFeedback: false, feedbackLevel: 'question',
        feedbackSource: 'ai', useAllQuestions: true, randomizeAlts: false
      });
      
      const [uploadedFile, setUploadedFile] = useState(null);
      const [fileContent, setFileContent] = useState(null);
      const [lastPrompt, setLastPrompt] = useState('');
      const [showAddMenu, setShowAddMenu] = useState(false);

      const shuffleArray = (array) => {
        const shuffled = [...array];
        for (let i = shuffled.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
      };

      const createQuestion = () => ({
        id: Date.now(), questionType: 'Single Choice', scoring: 'Simple', questionText: '',
        points: '10', tags: '', numAlts: 4, correctFb: '', incorrectFb: '', showFeedback: false,
        alternatives: Array(5).fill(null).map(() => ({ text: '', correct: false, pct: '', feedback: '' }))
      });

      const updateQ = (idx, field, value) => {
        const updated = [...questions];
        updated[idx] = { ...updated[idx], [field]: value };
        if (field === 'questionType' && value === 'Single Choice') updated[idx].scoring = 'Simple';
        setQuestions(updated);
      };

      const updateAlt = (qIdx, aIdx, field, value) => {
        const updated = [...questions];
        const q = updated[qIdx];
        q.alternatives = q.alternatives.map((a, i) => {
          if (i === aIdx) {
            if (field === 'correct' && value && q.questionType === 'Single Choice') return { ...a, correct: true };
            return { ...a, [field]: value };
          }
          if (field === 'correct' && value && q.questionType === 'Single Choice') return { ...a, correct: false };
          return a;
        });
        setQuestions(updated);
      };

      const extractPdfText = async (arrayBuffer) => {
        const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        let fullText = '';
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const textContent = await page.getTextContent();
          fullText += textContent.items.map(item => item.str).join(' ') + '\n';
        }
        return fullText;
      };

      const extractPptxText = async (arrayBuffer) => {
        const zip = await JSZip.loadAsync(arrayBuffer);
        let fullText = '';
        const slideFiles = Object.keys(zip.files).filter(name => name.match(/ppt\/slides\/slide\d+\.xml$/))
          .sort((a, b) => parseInt(a.match(/slide(\d+)/)[1]) - parseInt(b.match(/slide(\d+)/)[1]));
        for (const slideFile of slideFiles) {
          const content = await zip.files[slideFile].async('string');
          const textMatches = content.match(/<a:t>([^<]*)<\/a:t>/g) || [];
          const slideText = textMatches.map(match => match.replace(/<a:t>|<\/a:t>/g, '')).join(' ');
          if (slideText.trim()) fullText += slideText + '\n\n';
        }
        return fullText || '[No text content found]';
      };

      const handleFile = async (file) => {
        if (!file) return;
        setUploadedFile(file);
        setGenStatus('Reading file...');
        try {
          if (file.type === 'application/pdf') {
            const text = await extractPdfText(await file.arrayBuffer());
            setFileContent({ type: 'text/plain', text }); setGenStatus('');
          } else if (file.name.endsWith('.docx')) {
            const result = await mammoth.extractRawText({ arrayBuffer: await file.arrayBuffer() });
            setFileContent({ type: 'text/plain', text: result.value }); setGenStatus('');
          } else if (file.name.endsWith('.pptx')) {
            const text = await extractPptxText(await file.arrayBuffer());
            setFileContent({ type: 'text/plain', text }); setGenStatus('');
          } else if (file.name.endsWith('.doc') || file.name.endsWith('.ppt')) {
            setGenStatus('Note: Legacy formats not supported. Please convert to .docx or .pptx');
            setFileContent(null);
          } else if (file.type.startsWith('image/')) {
            setFileContent({ type: 'image', text: `[Image: ${file.name}]` });
            setGenStatus('Note: Images cannot be processed. Please use PDF, Word, or PowerPoint.');
          } else {
            setFileContent({ type: 'text/plain', text: await file.text() }); setGenStatus('');
          }
        } catch (err) { setGenStatus('Error: ' + err.message); }
      };

      const handleFileInput = (e) => { if (e.target.files?.[0]) handleFile(e.target.files[0]); };
      const handleDragOver = (e) => { e.preventDefault(); setIsDragging(true); };
      const handleDragLeave = (e) => { e.preventDefault(); setIsDragging(false); };
      const handleDrop = (e) => { e.preventDefault(); setIsDragging(false); if (e.dataTransfer.files?.[0]) handleFile(e.dataTransfer.files[0]); };
      const cancelGeneration = () => { if (abortControllerRef.current) { abortControllerRef.current.abort(); setIsGenerating(false); setGenStatus('Cancelled.'); } };

      const clearAll = () => {
        setQuestions([]); setLastPrompt(''); setShowAddMenu(false); setShowAIPanel(false);
        setErrors([]); setShowErrors(false); setUploadedFile(null); setFileContent(null);
        setAiSettings({ topic: '', pastedQuestions: '', numQuestions: 5, points: 10, qType: 'Single Choice',
          numAlts: 4, tags: '', difficulty: 'N/A', addFeedback: false, feedbackLevel: 'question',
          feedbackSource: 'ai', useAllQuestions: true, randomizeAlts: false });
      };

      const generateQuestions = async () => {
        if (aiMode === 'topic' && !aiSettings.topic.trim()) { setGenStatus('Please enter a topic.'); return; }
        if (aiMode === 'paste' && !aiSettings.pastedQuestions.trim()) { setGenStatus('Please paste questions.'); return; }
        if (aiMode === 'upload' && !fileContent) { setGenStatus('Please upload a document.'); return; }
        if (aiMode === 'upload' && fileContent?.type === 'image') { setGenStatus('Images not supported.'); return; }

        setIsGenerating(true);
        setGenStatus('Generating questions... This may take 10-20 seconds.');
        abortControllerRef.current = new AbortController();

        let prompt = '';
        const jsonExample = `{"questions":[{"questionType":"Single Choice","scoring":"Simple","questionText":"What is X?","points":10,"tags":"","correctFeedback":"","incorrectFeedback":"","alternatives":[{"text":"Option A","correct":true,"feedback":""},{"text":"Option B","correct":false,"feedback":""}]}]}`;
        
        const feedbackInstr = !aiSettings.addFeedback ? 'Do NOT include any feedback fields - leave correctFeedback, incorrectFeedback, and alternative feedback as empty strings ""' :
          aiSettings.feedbackSource === 'generic' ? 'Use generic feedback: correctFeedback="Correct! Great job.", incorrectFeedback="Incorrect. Please review the material."' :
          aiSettings.feedbackSource === 'inherited' ? 'IMPORTANT: Look for "Rationale for correct answer:" or "Rationale:" in the source. Extract ONLY the explanation text (remove the "Rationale for correct answer: A and B." prefix - just keep the actual explanation). Put this in correctFeedback. For incorrectFeedback use "Incorrect. Please review the material." Do NOT put feedback in alternatives - use question-level feedback only.' :
          (aiSettings.feedbackLevel === 'alternative' ? 'Include educational "feedback" for each alternative explaining why it is correct or incorrect' :
          'Include educational "correctFeedback" and "incorrectFeedback" at question level');

        if (aiMode === 'topic') {
          // For topic mode, check if user mentions feedback in their prompt
          const topicLower = aiSettings.topic.toLowerCase();
          const mentionsFeedback = topicLower.includes('feedback');
          const wantsQuestionLevel = topicLower.includes('question level') || topicLower.includes('question-level');
          const wantsAltLevel = topicLower.includes('alternative level') || topicLower.includes('alternative-level') || topicLower.includes('alt level');
          
          let topicFeedbackInstr = 'Do NOT include feedback - leave correctFeedback, incorrectFeedback, and alternative feedback as empty strings ""';
          if (mentionsFeedback) {
            if (wantsAltLevel) {
              topicFeedbackInstr = 'For Single Choice: include "feedback" for each alternative (leave correctFeedback/incorrectFeedback empty). For Multiple Choice: include "correctFeedback" and "incorrectFeedback" at question level (no alternative feedback).';
            } else {
              // Default to question-level, or if they explicitly asked for it
              topicFeedbackInstr = 'Include "correctFeedback" and "incorrectFeedback" at question level. Do NOT include alternative-level feedback. Leave all alternative feedback as empty strings.';
            }
          }
          
          prompt = `Generate quiz questions based on: "${aiSettings.topic}"

RULES:
- Follow all specifications in the request exactly
- Single Choice = exactly 1 correct answer, Multiple Choice = 2 or more correct
- Only include tags if explicitly mentioned in the request
- FEEDBACK RULES: ${topicFeedbackInstr}

RESPOND WITH ONLY VALID JSON (no markdown, no explanation):
${jsonExample}`;
        } else if (aiMode === 'paste') {
          prompt = `Convert these questions to JSON format:

${aiSettings.pastedQuestions}

RULES:
- Keep alternatives in EXACT order as given
- Question type: ${aiSettings.qType === 'Randomize' ? 'Vary between Single Choice and Multiple Choice' : aiSettings.qType}
- Points: ${aiSettings.points} per question
- Tags: ${aiSettings.tags || 'leave empty ""'}
- ${feedbackInstr}
- If correct answer is marked with * or "correct", set that alternative's correct:true

RESPOND WITH ONLY VALID JSON (no markdown, no explanation):
${jsonExample}`;
        } else {
          const content = fileContent?.text || '';
          const extractAll = aiSettings.useAllQuestions;
          prompt = `${extractAll ? 'Extract ALL quiz questions from this document' : 'Generate ' + aiSettings.numQuestions + ' quiz questions based on this content'}:

${content}

RULES:
- ${extractAll ? 'Find and extract every question with its alternatives' : 'Create questions based on the content'}
- Keep alternatives in their EXACT original order (A, B, C, D)
- Question type: ${aiSettings.qType === 'As in file' ? 'Determine from content - if multiple answers marked correct use Multiple Choice, otherwise Single Choice' : aiSettings.qType}
- Points: ${aiSettings.points} per question
- Tags: ${aiSettings.tags || 'leave empty ""'}
- ${feedbackInstr}
- For Multiple Choice (2+ correct answers): set scoring to "Simple"
- Look for answer keys like "Rationale for correct answer: A and B" to determine which alternatives are correct

RESPOND WITH ONLY VALID JSON (no markdown, no code blocks, no explanation):
${jsonExample}`;
        }

        try {
          const res = await fetch('/api/generate', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt }), signal: abortControllerRef.current.signal
          });
          const data = await res.json();
          if (data.error) throw new Error(data.error);
          
          let parsed = null;
          let responseText = data.text || '';
          
          // Remove markdown code blocks if present
          responseText = responseText.replace(/```json\s*/gi, '').replace(/```\s*/g, '');
          
          // Try to find JSON object
          const jsonMatch = responseText.match(/\{[\s\S]*\}/);
          if (jsonMatch) {
            try { 
              parsed = JSON.parse(jsonMatch[0]); 
            } catch (e) {
              // Try to fix common JSON issues
              let fixed = jsonMatch[0]
                .replace(/,\s*}/g, '}')  // trailing commas
                .replace(/,\s*]/g, ']')  // trailing commas in arrays
                .replace(/'/g, '"');      // single quotes to double
              try { parsed = JSON.parse(fixed); } catch (e2) {}
            }
          }
          
          if (!parsed?.questions || !Array.isArray(parsed.questions)) {
            console.error('Failed to parse:', responseText.substring(0, 500));
            throw new Error('Could not parse AI response. Please try again.');
          }
          
          const newQs = parsed.questions.map((q, i) => {
            const alts = q.alternatives || [];
            const processedAlts = aiSettings.randomizeAlts ? shuffleArray(alts) : alts;
            
            const hasQFb = q.correctFeedback || q.incorrectFeedback;
            const hasAltFb = alts.some(a => a.feedback);
            
            // Determine which feedback type to use:
            // - Multiple Choice: always question-level only
            // - Single Choice: if has question-level, use that; otherwise use alternative-level
            // - Inherited/Generic in paste/upload: always question-level
            const isMultipleChoice = (q.questionType || 'Single Choice') === 'Multiple Choice';
            const forceQuestionLevel = isMultipleChoice || 
              (aiMode !== 'topic' && (aiSettings.feedbackSource === 'inherited' || aiSettings.feedbackSource === 'generic'));
            const useAltFeedback = !forceQuestionLevel && !hasQFb && hasAltFb;
            
            return {
              ...createQuestion(), id: Date.now() + i, questionType: q.questionType || 'Single Choice',
              scoring: q.scoring || 'Simple', questionText: q.questionText || '', points: String(q.points || 10),
              tags: q.tags || '', numAlts: Math.min(processedAlts.length || 4, 5),
              correctFb: q.correctFeedback || '', incorrectFb: q.incorrectFeedback || '', 
              showFeedback: hasQFb || hasAltFb,
              alternatives: [...processedAlts.slice(0, 5).map(a => ({
                text: a.text || '', correct: !!a.correct, pct: '', 
                feedback: useAltFeedback ? (a.feedback || '') : ''  // Only keep alt feedback if using alt-level
              })), ...Array(5).fill(null)].slice(0, 5).map(a => a || { text: '', correct: false, pct: '', feedback: '' })
            };
          });
          
          setQuestions([...questions, ...newQs]);
          setLastPrompt(aiMode === 'topic' ? aiSettings.topic : aiMode === 'paste' ? aiSettings.pastedQuestions : 'From document');
          setShowAIPanel(false); setGenStatus(''); setUploadedFile(null); setFileContent(null);
        } catch (err) {
          if (err.name === 'AbortError') setGenStatus('Cancelled.');
          else setGenStatus('Error: ' + err.message);
        }
        setIsGenerating(false);
      };

      const hasAltFeedback = (q) => q.alternatives?.some(a => a?.feedback?.trim());
      const hasQFeedback = (q) => q.correctFb?.trim() || q.incorrectFb?.trim();

      const validateAll = () => {
        const errs = [];
        questions.forEach((q, i) => {
          const n = i + 1;
          if (!q.questionText.trim()) errs.push('Q' + n + ': Missing question');
          const alts = q.alternatives.slice(0, q.numAlts).filter(a => a.text.trim());
          if (alts.length < 2) errs.push('Q' + n + ': Need 2+ alternatives');
          const correct = alts.filter(a => a.correct).length;
          if (!correct) errs.push('Q' + n + ': No correct answer');
          if (q.questionType === 'Single Choice' && correct > 1) errs.push('Q' + n + ': Single Choice allows only 1 correct');
        });
        setErrors(errs); setShowErrors(true);
        return errs.length === 0;
      };

      const exportCsv = () => {
        if (!validateAll()) return;
        const headers = ['Question Type','Instruction Type','Instruction Content','Question','Points','Question Tags','Scoring','Formula','Correct Answer','Correct','Number Alternative','Alternatives','Percentage','Left Side','Right Side','Calculation','Answer','Feedback Type','Alternative Feedback','Correct Feedback','Incorrect Feedback'];
        const rows = [];
        questions.forEach(q => {
          const alts = q.alternatives.slice(0, q.numAlts).filter(a => a.text.trim());
          const correctCount = alts.filter(a => a.correct).length;
          const hasFb = hasAltFeedback(q), hasQFb = hasQFeedback(q);
          const feedbackType = hasFb ? 'Alternative' : hasQFb ? 'Question' : '';
          alts.forEach((alt, ai) => {
            const row = Array(21).fill('');
            row[0] = ai === 0 ? (q.questionType === 'Single Choice' ? 'SC' : 'MC') : '-';
            row[3] = ai === 0 ? q.questionText : '';
            row[4] = ai === 0 ? q.points : '';
            row[5] = ai === 0 ? q.tags : '';
            row[6] = ai === 0 && q.questionType === 'Multiple Choice' ? q.scoring : '';
            row[8] = ai === 0 && q.questionType === 'Multiple Choice' ? String(correctCount) : '';
            row[9] = alt.correct ? 'TRUE' : 'FALSE';
            row[10] = ai === 0 ? String(alts.length) : '';
            row[11] = alt.text;
            row[12] = q.questionType === 'Multiple Choice' && q.scoring === 'Weighted' && alt.correct ? String(Math.round(100/correctCount)) : '';
            row[17] = ai === 0 ? feedbackType : '';
            row[18] = hasFb ? alt.feedback : '';
            row[19] = ai === 0 && hasQFb ? q.correctFb : '';
            row[20] = ai === 0 && hasQFb ? q.incorrectFb : '';
            rows.push(row);
          });
          rows.push(Array(21).fill(''));
        });
        const escape = (v) => { 
          let s = String(v || '').replace(/\r\n/g, ' ').replace(/\r/g, ' ').replace(/\n/g, ' ').trim(); 
          return s.includes(',') || s.includes('"') ? '"' + s.replace(/"/g, '""') + '"' : s; 
        };
        const csv = [headers.map(escape).join(','), ...rows.map(r => r.map(escape).join(','))].join('\r\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const now = new Date();
        const ts = now.getFullYear() + String(now.getMonth()+1).padStart(2,'0') + String(now.getDate()).padStart(2,'0') + '_' + String(now.getHours()).padStart(2,'0') + String(now.getMinutes()).padStart(2,'0') + String(now.getSeconds()).padStart(2,'0');
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'quiz_export_' + ts + '.csv'; a.click();
      };

      const inputStyle = { width: '100%', padding: '10px 12px', border: '1px solid #ddd', borderRadius: '4px', fontSize: '14px' };
      const btnPrimary = { padding: '10px 20px', backgroundColor: '#f37021', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer', fontWeight: '500', fontSize: '14px' };
      const btnSecondary = { padding: '8px 16px', backgroundColor: '#f5f5f5', color: '#333', border: '1px solid #ddd', borderRadius: '4px', cursor: 'pointer', fontSize: '14px' };
      const checkboxStyle = { display: 'flex', alignItems: 'center', gap: '8px', marginTop: '16px', cursor: 'pointer', fontSize: '14px', color: '#333' };

      return (
        <div style={{ minHeight: '100vh', backgroundColor: '#f5f5f5' }}>
          <div style={{ backgroundColor: '#fff', padding: '12px 24px', borderBottom: '2px solid #f37021', display: 'flex', justifyContent: 'space-between', alignItems: 'center', position: 'sticky', top: 0, zIndex: 100 }}>
            <h1 style={{ margin: 0, color: '#333', fontSize: '20px', fontWeight: '600' }}>Quiz Builder</h1>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
              {questions.length > 0 && <span style={{ color: '#666', fontSize: '14px' }}>{questions.length} question(s)</span>}
              {questions.length > 0 && <button onClick={clearAll} style={btnSecondary}>Start Over</button>}
              {questions.length > 0 && <button onClick={exportCsv} style={{ ...btnPrimary, backgroundColor: '#5cb85c' }}>Export CSV</button>}
              <div style={{ position: 'relative' }}>
                <button onClick={() => setShowAddMenu(!showAddMenu)} style={btnPrimary}>+ Add Questions</button>
                {showAddMenu && (
                  <div style={{ position: 'absolute', top: '100%', right: 0, marginTop: '4px', backgroundColor: '#fff', borderRadius: '4px', boxShadow: '0 2px 8px rgba(0,0,0,0.15)', minWidth: '220px', zIndex: 200 }}>
                    <div onClick={() => { setAiMode('topic'); setShowAIPanel(true); setShowAddMenu(false); setGenStatus(''); }} style={{ padding: '12px 16px', cursor: 'pointer', borderBottom: '1px solid #eee', display: 'flex', alignItems: 'center', gap: '12px' }}>
                      <span style={{ fontSize: '20px' }}>‚ú®</span>
                      <div><div style={{ fontWeight: '500' }}>AI Generate</div><div style={{ fontSize: '12px', color: '#888' }}>AI creates questions from topic</div></div>
                    </div>
                    <div onClick={() => { setAiMode('paste'); setShowAIPanel(true); setShowAddMenu(false); setGenStatus(''); }} style={{ padding: '12px 16px', cursor: 'pointer', borderBottom: '1px solid #eee', display: 'flex', alignItems: 'center', gap: '12px' }}>
                      <span style={{ fontSize: '20px' }}>üìã</span>
                      <div><div style={{ fontWeight: '500' }}>Paste Questions</div><div style={{ fontSize: '12px', color: '#888' }}>AI processes & formats</div></div>
                    </div>
                    <div onClick={() => { setAiMode('upload'); setShowAIPanel(true); setShowAddMenu(false); setGenStatus(''); }} style={{ padding: '12px 16px', cursor: 'pointer', borderBottom: '1px solid #eee', display: 'flex', alignItems: 'center', gap: '12px' }}>
                      <span style={{ fontSize: '20px' }}>üìÑ</span>
                      <div><div style={{ fontWeight: '500' }}>From Document</div><div style={{ fontSize: '12px', color: '#888' }}>PDF, Word, PowerPoint</div></div>
                    </div>
                    <div onClick={() => { setQuestions([...questions, createQuestion()]); setShowAddMenu(false); }} style={{ padding: '12px 16px', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '12px' }}>
                      <span style={{ fontSize: '20px' }}>‚úèÔ∏è</span>
                      <div><div style={{ fontWeight: '500' }}>Manual Entry</div><div style={{ fontSize: '12px', color: '#888' }}>Create from scratch</div></div>
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>

          {showAddMenu && <div onClick={() => setShowAddMenu(false)} style={{ position: 'fixed', inset: 0, zIndex: 50 }} />}

          <div style={{ maxWidth: '1200px', margin: '0 auto', padding: '24px' }}>
            {lastPrompt && questions.length > 0 && (
              <div style={{ marginBottom: '20px', padding: '14px 18px', backgroundColor: '#fff', borderRadius: '4px', border: '1px solid #ddd' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', gap: '16px' }}>
                  <div style={{ flex: 1 }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '6px' }}>
                      <span style={{ color: '#f37021', fontSize: '14px' }}>‚ú®</span>
                      <span style={{ color: '#888', fontSize: '12px', fontWeight: '500', textTransform: 'uppercase' }}>Last AI Prompt</span>
                    </div>
                    <p style={{ margin: 0, color: '#333', fontSize: '14px', lineHeight: '1.5' }}>{lastPrompt}</p>
                  </div>
                  <button onClick={() => { setAiMode('topic'); setShowAIPanel(true); setGenStatus(''); }} style={btnSecondary}>Edit & Regenerate</button>
                </div>
              </div>
            )}

            {showAIPanel && (
              <div style={{ position: 'fixed', inset: 0, backgroundColor: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '20px' }}>
                <div style={{ backgroundColor: '#fff', borderRadius: '6px', width: '100%', maxWidth: '600px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 4px 20px rgba(0,0,0,0.15)' }}>
                  <div style={{ padding: '18px 20px', borderBottom: '1px solid #ddd', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <h2 style={{ margin: 0, color: '#333', fontSize: '18px', fontWeight: '600' }}>‚ú® AI Quiz Generator</h2>
                    <button onClick={() => { setShowAIPanel(false); cancelGeneration(); }} style={{ background: 'none', border: 'none', color: '#999', fontSize: '24px', cursor: 'pointer' }}>√ó</button>
                  </div>
                  
                  <div style={{ display: 'flex', borderBottom: '1px solid #ddd' }}>
                    {[['topic', 'üí° Topic'], ['paste', 'üìã Paste'], ['upload', 'üìÑ Upload']].map(([id, label]) => (
                      <button key={id} onClick={() => { setAiMode(id); setGenStatus(''); }} style={{ flex: 1, padding: '12px', backgroundColor: aiMode === id ? '#fff' : '#f9f9f9', color: aiMode === id ? '#f37021' : '#666', border: 'none', borderBottom: aiMode === id ? '2px solid #f37021' : '2px solid transparent', cursor: 'pointer', fontWeight: '500' }}>{label}</button>
                    ))}
                  </div>
                  
                  <div style={{ padding: '20px' }}>
                    {aiMode === 'topic' && (
                      <div>
                        <label style={{ display: 'block', marginBottom: '8px', color: '#666', fontSize: '13px', fontWeight: '500' }}>Describe what you want</label>
                        <textarea value={aiSettings.topic} onChange={e => setAiSettings({ ...aiSettings, topic: e.target.value })} placeholder="e.g., Create 10 quiz questions about bloodborne pathogens for healthcare workers. Randomize between Single Choice and Multiple Choice. 10 points each. Include encouraging feedback." rows={6} style={{ ...inputStyle, resize: 'vertical' }} />
                        <p style={{ margin: '8px 0 0', color: '#999', fontSize: '12px' }}>üí° AI interprets your full request. Specify: questions, types, scoring, points, tags (only if needed), feedback.</p>
                      </div>
                    )}
                    
                    {aiMode === 'paste' && (
                      <div>
                        <label style={{ display: 'block', marginBottom: '8px', color: '#666', fontSize: '13px', fontWeight: '500' }}>Paste your questions</label>
                        <textarea value={aiSettings.pastedQuestions} onChange={e => setAiSettings({ ...aiSettings, pastedQuestions: e.target.value })} placeholder={"Questions only:\nWhat is the maximum time to report a HIPAA breach?\n\nOr with alternatives (mark correct with *):\nWhat is a bloodborne pathogen? A) Digestive bacterium B) *Microorganism in blood C) Cold virus"} rows={6} style={{ ...inputStyle, resize: 'vertical', fontFamily: 'monospace', fontSize: '13px' }} />
                        <p style={{ margin: '8px 0 0', color: '#999', fontSize: '12px' }}>üí° Paste questions only (AI generates alternatives) or include alternatives. Mark correct with *.</p>
                        
                        <div style={{ marginTop: '16px', display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '12px' }}>
                          <div><label style={{ display: 'block', marginBottom: '6px', color: '#666', fontSize: '13px' }}>Points</label><input type="number" value={aiSettings.points} onChange={e => setAiSettings({ ...aiSettings, points: +e.target.value })} style={inputStyle} /></div>
                          <div><label style={{ display: 'block', marginBottom: '6px', color: '#666', fontSize: '13px' }}>Type</label><select value={aiSettings.qType} onChange={e => setAiSettings({ ...aiSettings, qType: e.target.value })} style={inputStyle}><option>Single Choice</option><option>Multiple Choice</option><option>Randomize</option></select></div>
                          <div><label style={{ display: 'block', marginBottom: '6px', color: '#666', fontSize: '13px' }}>Alternatives</label><select value={aiSettings.numAlts} onChange={e => setAiSettings({ ...aiSettings, numAlts: +e.target.value })} style={inputStyle}>{[2,3,4,5].map(n => <option key={n} value={n}>{n}</option>)}</select></div>
                          <div><label style={{ display: 'block', marginBottom: '6px', color: '#666', fontSize: '13px' }}>Difficulty</label><select value={aiSettings.difficulty} onChange={e => setAiSettings({ ...aiSettings, difficulty: e.target.value })} style={inputStyle}><option>N/A</option><option>Easy</option><option>Medium</option><option>Hard</option></select></div>
                          <div style={{ gridColumn: 'span 2' }}><label style={{ display: 'block', marginBottom: '6px', color: '#666', fontSize: '13px' }}>Tags</label><input value={aiSettings.tags} onChange={e => setAiSettings({ ...aiSettings, tags: e.target.value })} placeholder="Leave blank for no tags" style={inputStyle} /></div>
                        </div>
                        
                        <label style={checkboxStyle}><input type="checkbox" checked={aiSettings.randomizeAlts} onChange={e => setAiSettings({ ...aiSettings, randomizeAlts: e.target.checked })} style={{ width: '18px', height: '18px', accentColor: '#f37021' }} />Randomize alternatives</label>
                        <label style={checkboxStyle}><input type="checkbox" checked={aiSettings.addFeedback} onChange={e => setAiSettings({ ...aiSettings, addFeedback: e.target.checked })} style={{ width: '18px', height: '18px', accentColor: '#f37021' }} />Add Feedback</label>
                        
                        {aiSettings.addFeedback && (
                          <div style={{ marginLeft: '26px', marginTop: '8px', padding: '12px', backgroundColor: '#f9f9f9', borderRadius: '4px' }}>
                            {aiSettings.qType === 'Single Choice' && aiSettings.feedbackSource === 'ai' && (
                              <div style={{ marginBottom: '12px' }}>
                                <label style={{ display: 'block', marginBottom: '6px', color: '#666', fontSize: '13px' }}>Feedback Level</label>
                                <div style={{ display: 'flex', gap: '16px' }}>
                                  <label style={{ display: 'flex', alignItems: 'center', gap: '6px', fontSize: '13px' }}><input type="radio" checked={aiSettings.feedbackLevel === 'question'} onChange={() => setAiSettings({ ...aiSettings, feedbackLevel: 'question' })} style={{ accentColor: '#f37021' }} />Question</label>
                                  <label style={{ display: 'flex', alignItems: 'center', gap: '6px', fontSize: '13px' }}><input type="radio" checked={aiSettings.feedbackLevel === 'alternative'} onChange={() => setAiSettings({ ...aiSettings, feedbackLevel: 'alternative' })} style={{ accentColor: '#f37021' }} />Alternative</label>
                                </div>
                              </div>
                            )}
                            <div>
                              <label style={{ display: 'block', marginBottom: '6px', color: '#666', fontSize: '13px' }}>Feedback Source</label>
                              <select value={aiSettings.feedbackSource} onChange={e => setAiSettings({ ...aiSettings, feedbackSource: e.target.value })} style={inputStyle}>
                                <option value="ai">AI Generated</option>
                                <option value="generic">Generic</option>
                                <option value="inherited">Inherited (from source)</option>
                              </select>
                              <p style={{ margin: '6px 0 0', color: '#888', fontSize: '11px' }}>
                                {aiSettings.feedbackSource === 'ai' && 'AI will create encouraging, educational feedback'}
                                {aiSettings.feedbackSource === 'generic' && 'Simple feedback: "Correct!" / "Incorrect"'}
                                {aiSettings.feedbackSource === 'inherited' && 'Use rationale from your content if available'}
                              </p>
                            </div>
                          </div>
                        )}
                      </div>
                    )}
                    
                    {aiMode === 'upload' && (
                      <div>
                        <div onClick={() => fileInputRef.current?.click()} onDragOver={handleDragOver} onDragLeave={handleDragLeave} onDrop={handleDrop} style={{ border: '2px dashed ' + (isDragging ? '#f37021' : '#ddd'), borderRadius: '6px', padding: '40px', textAlign: 'center', cursor: 'pointer', backgroundColor: isDragging ? '#fff5f0' : '#fafafa' }}>
                          <input ref={fileInputRef} type="file" onChange={handleFileInput} accept=".pdf,.txt,.docx,.pptx" style={{ display: 'none' }} />
                          {uploadedFile ? <p style={{ color: '#5cb85c', margin: 0, fontWeight: '500' }}>üìÑ {uploadedFile.name}</p> : <div><div style={{ fontSize: '32px', marginBottom: '8px' }}>üìÅ</div><p style={{ color: '#888', margin: 0 }}>Drop file or click to upload</p><p style={{ color: '#aaa', margin: '8px 0 0', fontSize: '12px' }}>PDF, Word, PowerPoint, Text</p></div>}
                        </div>
                        <p style={{ margin: '12px 0 0', color: '#999', fontSize: '12px' }}>üí° Upload training materials, protocols, or policy documents.</p>
                        
                        <div style={{ marginTop: '16px' }}>
                          <label style={checkboxStyle}><input type="checkbox" checked={aiSettings.useAllQuestions} onChange={e => setAiSettings({ ...aiSettings, useAllQuestions: e.target.checked, qType: e.target.checked ? 'As in file' : 'Single Choice' })} style={{ width: '18px', height: '18px', accentColor: '#f37021' }} />Use all questions from file</label>
                          <p style={{ margin: '4px 0 16px 26px', color: '#888', fontSize: '12px' }}>{aiSettings.useAllQuestions ? 'AI will process all questions found in your document' : 'AI will generate new questions based on the content'}</p>
                          
                          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '12px' }}>
                            {!aiSettings.useAllQuestions && <div><label style={{ display: 'block', marginBottom: '6px', color: '#666', fontSize: '13px' }}># Questions</label><input type="number" value={aiSettings.numQuestions} onChange={e => setAiSettings({ ...aiSettings, numQuestions: +e.target.value })} style={inputStyle} /></div>}
                            <div><label style={{ display: 'block', marginBottom: '6px', color: '#666', fontSize: '13px' }}>Points</label><input type="number" value={aiSettings.points} onChange={e => setAiSettings({ ...aiSettings, points: +e.target.value })} style={inputStyle} /></div>
                            {!aiSettings.useAllQuestions && <div><label style={{ display: 'block', marginBottom: '6px', color: '#666', fontSize: '13px' }}>Type</label><select value={aiSettings.qType} onChange={e => setAiSettings({ ...aiSettings, qType: e.target.value })} style={inputStyle}><option>Single Choice</option><option>Multiple Choice</option></select></div>}
                            <div><label style={{ display: 'block', marginBottom: '6px', color: '#666', fontSize: '13px' }}>Tags</label><input value={aiSettings.tags} onChange={e => setAiSettings({ ...aiSettings, tags: e.target.value })} style={inputStyle} /></div>
                          </div>
                          
                          <label style={checkboxStyle}><input type="checkbox" checked={aiSettings.randomizeAlts} onChange={e => setAiSettings({ ...aiSettings, randomizeAlts: e.target.checked })} style={{ width: '18px', height: '18px', accentColor: '#f37021' }} />Randomize alternatives</label>
                          <label style={checkboxStyle}><input type="checkbox" checked={aiSettings.addFeedback} onChange={e => setAiSettings({ ...aiSettings, addFeedback: e.target.checked })} style={{ width: '18px', height: '18px', accentColor: '#f37021' }} />Add Feedback</label>
                          
                          {aiSettings.addFeedback && (
                            <div style={{ marginLeft: '26px', marginTop: '8px', padding: '12px', backgroundColor: '#f9f9f9', borderRadius: '4px' }}>
                              {(aiSettings.qType === 'Single Choice' || aiSettings.qType === 'As in file') && aiSettings.feedbackSource === 'ai' && (
                                <div style={{ marginBottom: '12px' }}>
                                  <label style={{ display: 'block', marginBottom: '6px', color: '#666', fontSize: '13px' }}>Feedback Level</label>
                                  <div style={{ display: 'flex', gap: '16px' }}>
                                    <label style={{ display: 'flex', alignItems: 'center', gap: '6px', fontSize: '13px' }}><input type="radio" checked={aiSettings.feedbackLevel === 'question'} onChange={() => setAiSettings({ ...aiSettings, feedbackLevel: 'question' })} style={{ accentColor: '#f37021' }} />Question</label>
                                    <label style={{ display: 'flex', alignItems: 'center', gap: '6px', fontSize: '13px' }}><input type="radio" checked={aiSettings.feedbackLevel === 'alternative'} onChange={() => setAiSettings({ ...aiSettings, feedbackLevel: 'alternative' })} style={{ accentColor: '#f37021' }} />Alternative</label>
                                  </div>
                                </div>
                              )}
                              <div>
                                <label style={{ display: 'block', marginBottom: '6px', color: '#666', fontSize: '13px' }}>Feedback Source</label>
                                <select value={aiSettings.feedbackSource} onChange={e => setAiSettings({ ...aiSettings, feedbackSource: e.target.value })} style={inputStyle}>
                                  <option value="ai">AI Generated</option>
                                  <option value="generic">Generic</option>
                                  <option value="inherited">Inherited (from document)</option>
                                </select>
                                <p style={{ margin: '6px 0 0', color: '#888', fontSize: '11px' }}>
                                  {aiSettings.feedbackSource === 'ai' && 'AI will create encouraging, educational feedback'}
                                  {aiSettings.feedbackSource === 'generic' && 'Simple feedback: "Correct!" / "Incorrect"'}
                                  {aiSettings.feedbackSource === 'inherited' && 'Use rationale from your document if available'}
                                </p>
                              </div>
                            </div>
                          )}
                        </div>
                      </div>
                    )}
                    
                    {genStatus && (
                      <div style={{ marginTop: '12px' }}>
                        {isGenerating && <div style={{ marginBottom: '8px', backgroundColor: '#eee', borderRadius: '4px', overflow: 'hidden' }}><div className="progress-bar"></div></div>}
                        <p style={{ margin: 0, color: genStatus.includes('Error') || genStatus.includes('Please') ? '#d9534f' : '#666', fontSize: '13px' }}>{genStatus}</p>
                      </div>
                    )}
                  </div>
                  
                  <div style={{ padding: '16px 20px', borderTop: '1px solid #ddd', display: 'flex', justifyContent: 'flex-end', gap: '8px' }}>
                    {isGenerating && <button onClick={cancelGeneration} style={btnSecondary}>Cancel</button>}
                    <button onClick={generateQuestions} disabled={isGenerating} style={{ ...btnPrimary, opacity: isGenerating ? 0.7 : 1 }}>{isGenerating ? '‚è≥ Generating...' : '‚ú® Generate'}</button>
                  </div>
                </div>
              </div>
            )}

            {showErrors && errors.length > 0 && <div style={{ marginBottom: '20px', backgroundColor: '#fff', border: '1px solid #f5c6cb', borderRadius: '4px', padding: '14px 18px' }}><strong style={{ color: '#d9534f' }}>‚ö†Ô∏è Errors</strong><ul style={{ margin: '8px 0 0', paddingLeft: '20px', color: '#721c24', fontSize: '13px' }}>{errors.map((e, i) => <li key={i}>{e}</li>)}</ul></div>}
            {showErrors && errors.length === 0 && questions.length > 0 && <div style={{ marginBottom: '20px', backgroundColor: '#d4edda', borderRadius: '4px', padding: '14px 18px' }}><span style={{ color: '#155724' }}>‚úì All questions valid!</span></div>}

            {questions.length === 0 && !showAIPanel && (
              <div style={{ textAlign: 'center', padding: '60px 20px', backgroundColor: '#fff', borderRadius: '6px', border: '1px solid #ddd' }}>
                <div style={{ fontSize: '48px', marginBottom: '16px' }}>üìù</div>
                <h2 style={{ margin: '0 0 8px', color: '#333' }}>Ready to Build Your Quiz</h2>
                <p style={{ margin: '0 0 24px', color: '#888' }}>Choose how you'd like to add questions</p>
                <div style={{ display: 'flex', gap: '12px', justifyContent: 'center', flexWrap: 'wrap' }}>
                  <button onClick={() => { setAiMode('topic'); setShowAIPanel(true); }} style={btnPrimary}>‚ú® AI Generate</button>
                  <button onClick={() => { setAiMode('paste'); setShowAIPanel(true); }} style={btnSecondary}>üìã Paste Questions</button>
                  <button onClick={() => { setAiMode('upload'); setShowAIPanel(true); }} style={btnSecondary}>üìÑ From Document</button>
                  <button onClick={() => setQuestions([createQuestion()])} style={btnSecondary}>‚úèÔ∏è Manual Entry</button>
                </div>
              </div>
            )}

            {questions.map((q, qi) => (
              <div key={q.id} style={{ marginBottom: '16px', backgroundColor: '#fff', borderRadius: '6px', border: '1px solid #ddd', padding: '20px' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '16px' }}>
                  <span style={{ fontWeight: '600' }}>Question {qi + 1}</span>
                  <button onClick={() => setQuestions(questions.filter((_, i) => i !== qi))} style={{ background: 'none', border: 'none', color: '#d9534f', cursor: 'pointer' }}>üóëÔ∏è</button>
                </div>
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '12px', marginBottom: '16px' }}>
                  <div><label style={{ display: 'block', marginBottom: '6px', color: '#666', fontSize: '13px' }}>Type</label><select value={q.questionType} onChange={e => updateQ(qi, 'questionType', e.target.value)} style={inputStyle}><option>Single Choice</option><option>Multiple Choice</option></select></div>
                  {q.questionType === 'Multiple Choice' && <div><label style={{ display: 'block', marginBottom: '6px', color: '#666', fontSize: '13px' }}>Scoring</label><select value={q.scoring} onChange={e => updateQ(qi, 'scoring', e.target.value)} style={inputStyle}><option>Simple</option><option>Weighted</option></select></div>}
                  <div><label style={{ display: 'block', marginBottom: '6px', color: '#666', fontSize: '13px' }}>Points</label><input type="number" value={q.points} onChange={e => updateQ(qi, 'points', e.target.value)} style={inputStyle} /></div>
                  <div><label style={{ display: 'block', marginBottom: '6px', color: '#666', fontSize: '13px' }}>Alternatives</label><select value={q.numAlts} onChange={e => updateQ(qi, 'numAlts', +e.target.value)} style={inputStyle}>{[2,3,4,5].map(n => <option key={n}>{n}</option>)}</select></div>
                  <div><label style={{ display: 'block', marginBottom: '6px', color: '#666', fontSize: '13px' }}>Tags</label><input value={q.tags} onChange={e => updateQ(qi, 'tags', e.target.value)} style={inputStyle} /></div>
                </div>
                <div style={{ marginBottom: '16px' }}><label style={{ display: 'block', marginBottom: '6px', color: '#666', fontSize: '13px' }}>Question</label><textarea value={q.questionText} onChange={e => updateQ(qi, 'questionText', e.target.value)} rows={2} style={{ ...inputStyle, resize: 'vertical' }} /></div>
                <div style={{ marginBottom: '16px' }}>
                  <label style={{ display: 'block', marginBottom: '10px', color: '#666', fontSize: '13px' }}>Alternatives</label>
                  {q.alternatives.slice(0, q.numAlts).map((alt, ai) => (
                    <div key={ai} style={{ marginBottom: '10px' }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                        <input type="checkbox" checked={alt.correct} onChange={e => updateAlt(qi, ai, 'correct', e.target.checked)} style={{ width: '18px', height: '18px', accentColor: '#f37021' }} />
                        <input value={alt.text} onChange={e => updateAlt(qi, ai, 'text', e.target.value)} placeholder={'Alternative ' + (ai + 1)} style={{ ...inputStyle, flex: 1, backgroundColor: alt.correct ? '#f0fff0' : '#fff' }} />
                      </div>
                      {q.questionType === 'Single Choice' && hasAltFeedback(q) && (
                        <div style={{ marginTop: '8px', marginLeft: '30px' }}>
                          <input value={alt.feedback || ''} onChange={e => updateAlt(qi, ai, 'feedback', e.target.value)} placeholder={alt.correct ? 'Feedback: Correct! Explain why...' : 'Feedback: Explain why incorrect...'} style={{ ...inputStyle, fontSize: '13px' }} />
                        </div>
                      )}
                    </div>
                  ))}
                  <p style={{ margin: '8px 0 0', color: '#999', fontSize: '12px' }}>‚òëÔ∏è Check to mark correct. {q.questionType === 'Single Choice' ? 'Only 1 allowed.' : q.scoring === 'Weighted' ? 'Percentages auto-calculated.' : 'At least 1 incorrect required.'}</p>
                </div>
                {q.questionType === 'Single Choice' && !hasQFeedback(q) && !hasAltFeedback(q) && (
                  <button onClick={() => updateQ(qi, 'showFeedback', true)} style={{ ...btnSecondary, fontSize: '13px', padding: '6px 12px' }}>+ Add Feedback</button>
                )}
                {(q.questionType === 'Multiple Choice' || (q.questionType === 'Single Choice' && (hasQFeedback(q) || (q.showFeedback && !hasAltFeedback(q))))) && (
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                    <div><label style={{ display: 'block', marginBottom: '6px', color: '#666', fontSize: '13px' }}>Correct Feedback</label><input value={q.correctFb} onChange={e => updateQ(qi, 'correctFb', e.target.value)} placeholder="Great job! You correctly identified..." style={inputStyle} /></div>
                    <div><label style={{ display: 'block', marginBottom: '6px', color: '#666', fontSize: '13px' }}>Incorrect Feedback</label><input value={q.incorrectFb} onChange={e => updateQ(qi, 'incorrectFb', e.target.value)} placeholder="Review the section on..." style={inputStyle} /></div>
                  </div>
                )}
              </div>
            ))}

            {questions.length > 0 && (
              <div style={{ marginTop: '20px', padding: '14px 18px', backgroundColor: '#fff', borderRadius: '4px', border: '1px solid #ddd', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <span style={{ color: '#666' }}><strong>{questions.length}</strong> questions ‚Ä¢ <strong>{questions.reduce((s, q) => s + (+q.points || 0), 0)}</strong> points</span>
                <div style={{ display: 'flex', gap: '8px' }}>
                  <button onClick={clearAll} style={btnSecondary}>Start Over</button>
                  <button onClick={exportCsv} style={{ ...btnPrimary, backgroundColor: '#5cb85c' }}>Export CSV</button>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    ReactDOM.render(<QuizBuilder />, document.getElementById('root'));
  </script>
</body>
</html>
